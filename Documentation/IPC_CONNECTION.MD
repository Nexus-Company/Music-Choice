# Comunica√ß√£o via Pipes Nomeados 
Descri√ß√£o geral sobre a Comunica√ß√£o IPC e seus componentes. 
## üìñ Arquitetura Geral

O sistema √© composto por tr√™s principais componentes de gerenciamento:

* [PipeCommandDispatcher](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeCommandDispatcher.cs): Respons√°vel por gerenciar e despachar comandos recebidos de streams de leitura ([PipeReader](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeReader.cs)).
* [PipeEventDispatcher](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeEventDispatcher.cs): Respons√°vel por gerenciar e despachar eventos para streams de escrita ([PipeWriter](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeWriter.cs)).
* [PipeConnectionHandler](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeConnectionHandler.cs): Gerencia as conex√µes de clientes via Named Pipes, registrando streams de leitura e escrita e monitorando o estado das conex√µes.

Esses componentes trabalham em conjunto para permitir a comunica√ß√£o bidirecional (full-duplex) entre processos, garantindo que comandos possam ser recebidos enquanto eventos s√£o enviados simultaneamente.

## üì¶ Componentes e Responsabilidades

### [PipeCommandDispatcher](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeCommandDispatcher.cs)

* **Base**: Herda de [BaseCommandDispatcher](/Solution/Nexus.Music.Choice.Worker/Base/Dispatcher/BaseCommandDispatcher.cs) e implementa [ICommandDispatcher](/Solution/Nexus.Music.Choice.Worker/Base/Dispatcher/ICommandDispatcher.cs).
* **Fun√ß√£o**: Gerencia streams de leitura ([PipeReader](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeReader.cs)) e despacha comandos recebidos para os consumidores registrados.
* **Eventos**: `CommandReceived` (disparado quando um comando √© recebido).
* **Depend√™ncias**: `ILogger<PipeCommandDispatcher>`, [IInteractionService](/Solution/Nexus.Music.Choice.Worker/Interfaces/IInteractionService.cs).

### [PipeEventDispatcher](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeEventDispatcher.cs)

* **Base**: Herda de [BaseDispatcher](/Solution/Nexus.Music.Choice.Worker/Base/Dispatcher/BaseDispatcher.cs) e implementa `IEventDispatcher<T>`.
* **Fun√ß√£o**: Gerencia streams de escrita ([PipeWriter](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeWriter.cs)) e despacha eventos para os consumidores registrados.
* **M√©todos**: `DispatchEvent(Event @event)` (envia eventos para todos os streams registrados).
* **Depend√™ncias**: `ILogger<PipeEventDispatcher>`.

### [PipeConnectionHandler](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeConnectionHandler.cs)

* **Interface**: Implementa `IPipeConnectionHandler` e `IDisposable`.
* **Fun√ß√£o**: Gerencia conex√µes de clientes via Named Pipes.
* **Principais Responsabilidades**: Aceitar conex√µes, criar/registrar [PipeReader](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeReader.cs) e [PipeWriter](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeWriter.cs), monitorar estado e desconectar clientes quando necess√°rio.
* **Depend√™ncias**: `ILogger<PipeConnectionHandler>`, `ICommandDispatcher<PipeReader>`, `IEventDispatcher<PipeWriter>`.

### [PipeReader](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeReader.cs)

* **Fun√ß√£o**: Representa um stream de leitura que l√™ dados de um cliente conectado via Named Pipe.
* **Interface Base**: Implementa [IStreamReader](/Solution/Nexus.Music.Choice.Worker/Interfaces/IStream.cs).

### [PipeWriter](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeWriter.cs)

* **Fun√ß√£o**: Representa um stream de escrita que envia dados para um cliente conectado via Named Pipe.
* **Interface Base**: Implementa [IStreamWriter](/Solution/Nexus.Music.Choice.Worker/Interfaces/IStream.cs).

### [PipeWorker](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeWorker.cs)

* **Fun√ß√£o**: Provavelmente √© o ponto de entrada que inicializa e gerencia o ciclo de vida dos outros componentes.
* **Responsabilidades**: Configurar Named Pipes, iniciar e parar o sistema de comunica√ß√£o.

## üîÑ Fluxo de Comunica√ß√£o

![image](ipc_connection_sequence.png)

> üí° O diagrama acima demonstra como √© a execu√ß√£o de uma conex√£o IPC e como ela e tratada pela aplica√ß√£o, lembrando que o fluxo de envio (comandos), recebimento (eventos) ocorrem de forma independentes. 

1. **Conex√£o**

   * [PipeConnectionHandler](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeConnectionHandler.cs) aceita conex√µes de clientes via Named Pipes.
   * Para cada conex√£o, cria inst√¢ncias de [PipeReader](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeReader.cs) e [PipeWriter](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeWriter.cs) e registra nos despachantes.

2. **Recebimento de Comandos**

   * [PipeReader](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeReader.cs) l√™ dados do cliente.
   * [PipeCommandDispatcher](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeCommandDispatcher.cs) processa os dados e dispara o evento `CommandReceived`.

3. **Envio de Eventos**

   * [PipeEventDispatcher](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeEventDispatcher.cs) usa os [PipeWriter](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeWriter.cs) registrados para enviar eventos aos clientes.

4. **Monitoramento**

   * [PipeConnectionHandler](/Solution/Nexus.Music.Choice.Worker/PipeHandler/PipeConnectionHandler.cs) monitora o estado das conex√µes, desconectando clientes inativos ou quando o sistema √© encerrado.

## ‚öôÔ∏è Caracter√≠sticas T√©cnicas

* **C# 13.0 e .NET 9**: Uso de recursos modernos como `async/await`, inje√ß√£o de depend√™ncia, gerenciamento de streams.
* **Gerenciamento de Recursos**: Implementa√ß√£o de `IDisposable`, uso de `CancellationToken` para opera√ß√µes ass√≠ncronas.
* **Escalabilidade**: Suporte a m√∫ltiplas conex√µes simult√¢neas, gerenciamento por IDs de conex√£o.

## üõ†Ô∏è Teste no PowerShell

Voc√™ pode testar a comunica√ß√£o IPC usando este comando:

```powershell
$pipeName = "MusicChoicePipe"
$pipeClient = [System.IO.Pipes.NamedPipeClientStream]::new(".", $pipeName, [System.IO.Pipes.PipeDirection]::Out)
Write-Host "Conectando ao servidor..."
$pipeClient.Connect()

$writer = [System.IO.StreamWriter]::new($pipeClient)
$writer.AutoFlush = $true
$writer.WriteLine('{"ActionType":"VoteSkip"}')
Write-Host "Mensagem enviada."
$writer.Close()
$pipeClient.Close()
```
