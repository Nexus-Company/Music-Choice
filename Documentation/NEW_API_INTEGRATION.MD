# **üìÑ Documenta√ß√£o do Processo de Integra√ß√£o com M√∫ltiplas APIs via Windows Service**

Este documento descreve o processo de autentica√ß√£o e integra√ß√£o com v√°rias APIs externas de forma simult√¢nea em um **Windows Service**. O sistema foi projetado para ser facilmente extens√≠vel, permitindo a adi√ß√£o de novas APIs com m√≠nima configura√ß√£o.

---

## **üèõ Arquitetura Geral**

O sistema foi projetado para permitir que v√°rias APIs externas sejam integradas e monitoradas simultaneamente por meio de um **Windows Service**. A principal fun√ß√£o do sistema √© gerenciar a autentica√ß√£o das APIs e garantir que os tokens de autentica√ß√£o estejam sempre atualizados. A estrutura √© composta pelos seguintes componentes principais:

1. üîÑ **[AuthenticationMonitorWorker](/Solution/Nexus.Music.Choice.Worker/AuthenticationMonitorWorker.cs)**: O worker que monitora todas as APIs e verifica periodicamente o status de autentica√ß√£o.
2. üîë **[IApiAuthenticationService](/Solution/Nexus.Music.Choice.Domain/Services/IApiAuthenticationService.cs)**: Interface que define a l√≥gica de autentica√ß√£o espec√≠fica para cada API.
3. üåê **[IHttpProvisioningService](/Solution/Nexus.Music.Choice.Domain/Services/IHttpProvisioningService.cs)**: Servi√ßo respons√°vel por abrir uma porta HTTP e ouvir a comunica√ß√£o da API externa durante o processo de autentica√ß√£o.
4. üóÑ **[ITokenStoreService](/Solution/Nexus.Music.Choice.Domain/Services/ITokenStoreService.cs)**: Servi√ßo que gerencia os tokens de autentica√ß√£o, incluindo o armazenamento e recupera√ß√£o dos tokens.
5. üöÄ **IApiService**: Servi√ßo que consome o **access_token** para fazer requisi√ß√µes √† API externa.

Cada componente √© modular e pode ser facilmente configurado para integrar novas APIs. **Para integrar uma nova API, n√£o √© necess√°rio modificar ou implementar o `AuthenticationMonitorWorker`, mas apenas implementar as interfaces `IApiAuthenticationService` e `IApiService` espec√≠ficas da nova API.**

---

## **üîê Importante: Uso de Authorization Code Flow com PKCE**

Para integra√ß√µes que utilizam o **Authorization Code Flow** (fluxo de c√≥digo de autoriza√ß√£o), recomenda-se fortemente o uso de **PKCE (Proof Key for Code Exchange)**. O PKCE adiciona uma camada de seguran√ßa essencial ao fluxo, especialmente em cen√°rios onde a aplica√ß√£o n√£o pode manter um *client secret* seguro, como em aplica√ß√µes desktop ou servi√ßos distribu√≠dos. Ele evita ataques de intercepta√ß√£o de c√≥digo de autoriza√ß√£o, garantindo que apenas o cliente leg√≠timo possa trocar o c√≥digo por tokens.

No contexto deste sistema:  
‚úÖ A implementa√ß√£o de autentica√ß√£o com PKCE deve ser feita nas classes espec√≠ficas que implementam `IApiAuthenticationService`.  
‚úÖ Durante o processo de autentica√ß√£o, a URL gerada para o login do usu√°rio (que inclui os par√¢metros PKCE) deve ser **exposta ao ambiente de execu√ß√£o** de forma clara.

> **üí° Recomenda√ß√£o:**  
Configure o sistema para armazenar a URL inicial de login em uma vari√°vel de usu√°rio, como:

```powershell
MC_SPOTIFY_LOGIN_URL=https://accounts.spotify.com/authorize?...
```

Essa vari√°vel pode ser setada programaticamente ou via configura√ß√£o no ambiente, facilitando o acesso √† URL de login para que os usu√°rios possam concluir a autentica√ß√£o manualmente ou por meio de outro aplicativo (se necess√°rio).

Para acessar a URL de login voc√™ pode seguir o seguinte exemplo de comando:

```powershell
echo $env:MC_SPOTIFY_LOGIN_URL
```

---

## **‚öôÔ∏è Componentes e Responsabilidades**

### 1. üîÑ **[AuthenticationMonitorWorker](/Solution/Nexus.Music.Choice.Worker/AuthenticationMonitorWorker.cs)**  
Respons√°vel por monitorar todas as APIs registradas. Ele verifica, a cada **1 minuto**, se as autentica√ß√µes das APIs est√£o v√°lidas. Quando uma autentica√ß√£o expira ou se torna inv√°lida, o worker inicia o processo de autentica√ß√£o para a API correspondente.

**Responsabilidades:**  
- Verificar a autentica√ß√£o de todas as APIs a cada 1 minuto.  
- Invocar o m√©todo `CheckAuthenticationAsync()` de cada implementa√ß√£o de `IApiAuthenticationService` para validar a autentica√ß√£o.  
- Iniciar o processo de autentica√ß√£o atrav√©s do m√©todo `StartAuthenticationAsync()` quando necess√°rio.

### 2. üîë **[IApiAuthenticationService](/Solution/Nexus.Music.Choice.Domain/Services/IApiAuthenticationService.cs)**  
Define a interface que deve ser implementada para cada API. Cada implementa√ß√£o √© respons√°vel pela l√≥gica de autentica√ß√£o e renova√ß√£o de tokens de uma API espec√≠fica.

**Responsabilidades:**  
- `CheckAuthenticationAsync()`: Verifica se a autentica√ß√£o est√° v√°lida, retornando `true` se o token for v√°lido. Caso contr√°rio, tenta renovar o token utilizando o **refresh_token**.  
- `StartAuthenticationAsync()`: Inicia o processo de autentica√ß√£o com a API externa, acionando a comunica√ß√£o necess√°ria para obter um novo token.

### 3. üåê **[IHttpProvisioningService](/Solution/Nexus.Music.Choice.Domain/Services/IHttpProvisioningService.cs)**  
Respons√°vel por gerenciar a comunica√ß√£o HTTP entre o sistema e a API externa. Ele abre uma porta HTTP e aguarda o evento de autentica√ß√£o, acionado quando a API externa redireciona o usu√°rio para o servi√ßo.

**Responsabilidades:**  
- Abrir uma porta HTTP para aguardar mensagens de autentica√ß√£o.  
- Acionar o evento **HttpMessageReceived** quando o c√≥digo de autentica√ß√£o √© enviado pela API externa.

### 4. üóÑ **[ITokenStoreService](/Solution/Nexus.Music.Choice.Domain/Services/ITokenStoreService.cs)**  
Respons√°vel por armazenar e gerenciar os tokens de autentica√ß√£o (como **access_token** e **refresh_token**) para cada API.

**Responsabilidades:**  
- `GetTokenAsync()`: Recupera o **access_token** e o **refresh_token** armazenados.  
- `SaveTokenAsync()`: Armazena o **access_token** e o **refresh_token** ap√≥s a autentica√ß√£o ser conclu√≠da.

> ‚ö†Ô∏è **Nota:** Voc√™ n√£o deve armazenar o **access_token**, mas sim o **refresh_token**. A classe abstrata [BaseTokenStoreService](/Solution/Nexus.Music.Choice.Domain/Services/BaseTokenStoreService.cs) j√° salva de forma segura somente o **refresh_token**.

### 5. üöÄ **IApiService**  
Servi√ßo que consome o **access_token** para fazer requisi√ß√µes autenticadas √† API externa. Ele utiliza o **[IApiAuthenticationService](/Solution/Nexus.Music.Choice.Domain/Services/IApiAuthenticationService.cs)** para obter o token e interagir com a API.

**Responsabilidades:**  
- Esperar um novo **access_token** atrav√©s de um evento `AccessTokenChanged`.  
- Fazer requisi√ß√µes √† API externa utilizando o **access_token**.

> üîí Por seguran√ßa, cada API deve implementar [BaseTokenStoreService](/Solution/Nexus.Music.Choice.Domain/Services/BaseTokenStoreService.cs), garantindo que somente sua implementa√ß√£o tenha acesso aos **access_token**.

---

## **üîÅ Fluxo**

O fluxo do processo √© projetado para garantir que as autentica√ß√µes sejam verificadas e renovadas automaticamente. Veja o detalhamento:

1. **Verifica√ß√£o de Autentica√ß√£o**  
   - O **[AuthenticationMonitorWorker](/Solution/Nexus.Music.Choice.Worker/AuthenticationMonitorWorker.cs)** executa periodicamente, verificando se a autentica√ß√£o de cada API est√° v√°lida.  
   - Ele chama o m√©todo `CheckAuthenticationAsync()` de cada implementa√ß√£o de `IApiAuthenticationService`.  
   - Se os tokens estiverem v√°lidos, a API √© considerada autenticada.  
   - Caso contr√°rio, `StartAuthenticationAsync()` √© chamado para renovar a autentica√ß√£o.

2. **Processo de Autentica√ß√£o**  
   - O **[IApiAuthenticationService](/Solution/Nexus.Music.Choice.Domain/Services/IApiAuthenticationService.cs)** inicia o processo.  
   - O **[IHttpProvisioningService](/Solution/Nexus.Music.Choice.Domain/Services/IHttpProvisioningService.cs)** abre uma porta HTTP para receber o c√≥digo de autentica√ß√£o.  
   - O novo **refresh_token** √© armazenado usando `SaveTokenAsync()`.

3. **Renova√ß√£o de Token**  
   - Se o **access_token** expirar, `CheckAuthenticationAsync()` tenta renov√°-lo com o **refresh_token**.  
   - Se falhar, o processo completo √© reiniciado.

4. **Uso do Token para Requisi√ß√µes**  
   - O **IApiService** acessa o **access_token** via `GetAccessTokenAsync()`.  
   - Realiza as requisi√ß√µes √† API externa.

---

## **üõ† Exemplo**

### Integra√ß√£o de Nova API

Para integrar uma nova API, basta implementar as interfaces `IApiAuthenticationService` e `IApiService`. O **[AuthenticationMonitorWorker](/Solution/Nexus.Music.Choice.Worker/AuthenticationMonitorWorker.cs)** j√° gerencia essas integra√ß√µes automaticamente.

**Passos:**  
1. **Implementa√ß√£o de `ITokenStoreService`**  
   - Crie uma classe baseada em `BaseTokenStoreService`.  
   - Configure a distribui√ß√£o do `access_token`.

2. **Implementa√ß√£o de `IApiAuthenticationService`**  
   - Crie uma classe que implemente `IApiAuthenticationService`.  
   - Implemente os m√©todos `CheckAuthenticationAsync()` e `StartAuthenticationAsync()`.

3. **Implementa√ß√£o de `IApiService`**  
   - Crie uma classe que implemente `IApiService`.  
   - Obtenha e atualize o `access_token` com o `ITokenStoreService`.

4. **Registro no DI**  
   - Registre `IApiService` (Scoped), `IApiAuthenticationService` (Scoped) e `ITokenStoreService` (Singleton).

---

## **‚úÖ Conclus√£o**

Este sistema foi projetado para permitir a integra√ß√£o e autentica√ß√£o de m√∫ltiplas APIs de maneira simples e eficiente dentro de um **Windows Service**. Ele garante que a autentica√ß√£o seja sempre v√°lida e que os tokens sejam renovados automaticamente. A modularidade permite expandir facilmente para novas APIs, tornando-o altamente escal√°vel e flex√≠vel.
